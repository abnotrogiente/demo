var Re=Object.defineProperty;var Ae=(o,a,p)=>a in o?Re(o,a,{enumerable:!0,configurable:!0,writable:!0,value:p}):o[a]=p;var me=(o,a,p)=>Ae(o,typeof a!="symbol"?a+"":a,p);import"./modulepreload-polyfill-B5Qt9EMX.js";import{g as ze}from"./lil-gui.module.min-Vka56b52.js";var m=function(){var o,a={create:function(t){t=t||{};var i=document.createElement("canvas");i.width=800,i.height=600,"alpha"in t||(t.alpha=!1);try{o=i.getContext("webgl",t)}catch{}try{o=o||i.getContext("experimental-webgl",t)}catch{}if(!o)throw new Error("WebGL not supported");return o.HALF_FLOAT_OES=36193,p(),g(),T(),Q(),o},keys:{},Matrix:y,Indexer:N,Buffer:G,Mesh:P,HitTest:I,Raytracer:O,Shader:ie,Texture:C,Vector:u};function p(){o.MODELVIEW=K|1,o.PROJECTION=K|2;var t=new y,i=new y;o.modelviewMatrix=new y,o.projectionMatrix=new y;var e=[],r=[],n,s;o.matrixMode=function(l){switch(l){case o.MODELVIEW:n="modelviewMatrix",s=e;break;case o.PROJECTION:n="projectionMatrix",s=r;break;default:throw new Error("invalid matrix mode "+l)}},o.loadIdentity=function(){y.identity(o[n])},o.loadMatrix=function(l){for(var h=l.m,f=o[n].m,d=0;d<16;d++)f[d]=h[d]},o.multMatrix=function(l){o.loadMatrix(y.multiply(o[n],l,i))},o.perspective=function(l,h,f,d){o.multMatrix(y.perspective(l,h,f,d,t))},o.frustum=function(l,h,f,d,c,v){o.multMatrix(y.frustum(l,h,f,d,c,v,t))},o.ortho=function(l,h,f,d,c,v){o.multMatrix(y.ortho(l,h,f,d,c,v,t))},o.scale=function(l,h,f){o.multMatrix(y.scale(l,h,f,t))},o.translate=function(l,h,f){o.multMatrix(y.translate(l,h,f,t))},o.rotate=function(l,h,f,d){o.multMatrix(y.rotate(l,h,f,d,t))},o.lookAt=function(l,h,f,d,c,v,w,x,E){o.multMatrix(y.lookAt(l,h,f,d,c,v,w,x,E,t))},o.pushMatrix=function(){s.push(Array.prototype.slice.call(o[n].m))},o.popMatrix=function(){var l=s.pop();o[n].m=B?new Float32Array(l):l},o.project=function(l,h,f,d,c,v){d=d||o.modelviewMatrix,c=c||o.projectionMatrix,v=v||o.getParameter(o.VIEWPORT);var w=c.transformPoint(d.transformPoint(new u(l,h,f)));return new u(v[0]+v[2]*(w.x*.5+.5),v[1]+v[3]*(w.y*.5+.5),w.z*.5+.5)},o.unProject=function(l,h,f,d,c,v){d=d||o.modelviewMatrix,c=c||o.projectionMatrix,v=v||o.getParameter(o.VIEWPORT);var w=new u((l-v[0])/v[2]*2-1,(h-v[1])/v[3]*2-1,f*2-1);return y.inverse(y.multiply(c,d,t),i).transformPoint(w)},o.matrixMode(o.MODELVIEW)}function g(){var t={mesh:new P({coords:!0,colors:!0,triangles:!1}),mode:-1,coord:[0,0,0,0],color:[1,1,1,1],shader:new ie("      uniform float pointSize;      varying vec4 color;      varying vec4 coord;      void main() {        color = gl_Color;        coord = gl_TexCoord;        gl_Position = gl_ModelViewProjectionMatrix * gl_Vertex;        gl_PointSize = pointSize;      }    ","      uniform sampler2D texture;      uniform float pointSize;      uniform bool useTexture;      varying vec4 color;      varying vec4 coord;      void main() {        gl_FragColor = color;        if (useTexture) gl_FragColor *= texture2D(texture, coord.xy);      }    ")};o.pointSize=function(i){t.shader.uniforms({pointSize:i})},o.begin=function(i){if(t.mode!=-1)throw new Error("mismatched gl.begin() and gl.end() calls");t.mode=i,t.mesh.colors=[],t.mesh.coords=[],t.mesh.vertices=[]},o.color=function(i,e,r,n){t.color=arguments.length==1?i.toArray().concat(1):[i,e,r,n||1]},o.texCoord=function(i,e){t.coord=arguments.length==1?i.toArray(2):[i,e]},o.vertex=function(i,e,r){t.mesh.colors.push(t.color),t.mesh.coords.push(t.coord),t.mesh.vertices.push(arguments.length==1?i.toArray():[i,e,r])},o.end=function(){if(t.mode==-1)throw new Error("mismatched gl.begin() and gl.end() calls");t.mesh.compile(),t.shader.uniforms({useTexture:!!o.getParameter(o.TEXTURE_BINDING_2D)}).draw(t.mesh,t.mode),t.mode=-1}}function T(){var t=o,i=0,e=0,r={},n=!1,s=Object.prototype.hasOwnProperty;function l(){for(var x in r)if(s.call(r,x)&&r[x])return!0;return!1}function h(x){var E={};for(var b in x)typeof x[b]=="function"?E[b]=function(ee){return function(){ee.apply(x,arguments)}}(x[b]):E[b]=x[b];E.original=x,E.x=E.pageX,E.y=E.pageY;for(var z=o.canvas;z;z=z.offsetParent)E.x-=z.offsetLeft,E.y-=z.offsetTop;return n?(E.deltaX=E.x-i,E.deltaY=E.y-e):(E.deltaX=0,E.deltaY=0,n=!0),i=E.x,e=E.y,E.dragging=l(),E.preventDefault=function(){E.original.preventDefault()},E.stopPropagation=function(){E.original.stopPropagation()},E}function f(x){o=t,l()||(M(document,"mousemove",d),M(document,"mouseup",c),D(o.canvas,"mousemove",d),D(o.canvas,"mouseup",c)),r[x.which]=!0,x=h(x),o.onmousedown&&o.onmousedown(x),x.preventDefault()}function d(x){o=t,x=h(x),o.onmousemove&&o.onmousemove(x),x.preventDefault()}function c(x){o=t,r[x.which]=!1,l()||(D(document,"mousemove",d),D(document,"mouseup",c),M(o.canvas,"mousemove",d),M(o.canvas,"mouseup",c)),x=h(x),o.onmouseup&&o.onmouseup(x),x.preventDefault()}function v(){n=!1}function w(){r={},n=!1}M(o.canvas,"mousedown",f),M(o.canvas,"mousemove",d),M(o.canvas,"mouseup",c),M(o.canvas,"mouseover",v),M(o.canvas,"mouseout",v),M(document,"contextmenu",w)}function A(t){var i={8:"BACKSPACE",9:"TAB",13:"ENTER",16:"SHIFT",27:"ESCAPE",32:"SPACE",37:"LEFT",38:"UP",39:"RIGHT",40:"DOWN"};return i[t]||(t>=65&&t<=90?String.fromCharCode(t):null)}function M(t,i,e){t.addEventListener(i,e)}function D(t,i,e){t.removeEventListener(i,e)}M(document,"keydown",function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var i=A(t.keyCode);i&&(a.keys[i]=!0),a.keys[t.keyCode]=!0}}),M(document,"keyup",function(t){if(!t.altKey&&!t.ctrlKey&&!t.metaKey){var i=A(t.keyCode);i&&(a.keys[i]=!1),a.keys[t.keyCode]=!1}});function Q(){(function(t){o.makeCurrent=function(){o=t}})(o),o.animate=function(){var t=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||function(n){setTimeout(n,16.666666666666668)},i=new Date().getTime(),e=o;function r(){o=e;var n=new Date().getTime();o.onupdate&&o.onupdate((n-i)/1e3),o.ondraw&&o.ondraw(),t(r),i=n}r()},o.fullscreen=function(t){t=t||{};var i=t.paddingTop||0,e=t.paddingLeft||0,r=t.paddingRight||0,n=t.paddingBottom||0;if(!document.body)throw new Error("document.body doesn't exist yet (call gl.fullscreen() from window.onload() or from inside the <body> tag)");document.body.appendChild(o.canvas),document.body.style.overflow="hidden",o.canvas.style.position="absolute",o.canvas.style.left=e+"px",o.canvas.style.top=i+"px";function s(){o.canvas.width=window.innerWidth-e-r,o.canvas.height=window.innerHeight-i-n,o.viewport(0,0,o.canvas.width,o.canvas.height),(t.camera||!("camera"in t))&&(o.matrixMode(o.PROJECTION),o.loadIdentity(),o.perspective(t.fov||45,o.canvas.width/o.canvas.height,t.near||.1,t.far||1e3),o.matrixMode(o.MODELVIEW)),o.ondraw&&o.ondraw()}M(window,"resize",s),s()}}var K=305397760,B=typeof Float32Array<"u";function y(){var t=Array.prototype.concat.apply([],arguments);t.length||(t=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this.m=B?new Float32Array(t):t}y.prototype={inverse:function(){return y.inverse(this,new y)},transpose:function(){return y.transpose(this,new y)},multiply:function(t){return y.multiply(this,t,new y)},transformPoint:function(t){var i=this.m;return new u(i[0]*t.x+i[1]*t.y+i[2]*t.z+i[3],i[4]*t.x+i[5]*t.y+i[6]*t.z+i[7],i[8]*t.x+i[9]*t.y+i[10]*t.z+i[11]).divide(i[12]*t.x+i[13]*t.y+i[14]*t.z+i[15])},transformVector:function(t){var i=this.m;return new u(i[0]*t.x+i[1]*t.y+i[2]*t.z,i[4]*t.x+i[5]*t.y+i[6]*t.z,i[8]*t.x+i[9]*t.y+i[10]*t.z)}},y.inverse=function(t,i){i=i||new y;var e=t.m,r=i.m;r[0]=e[5]*e[10]*e[15]-e[5]*e[14]*e[11]-e[6]*e[9]*e[15]+e[6]*e[13]*e[11]+e[7]*e[9]*e[14]-e[7]*e[13]*e[10],r[1]=-e[1]*e[10]*e[15]+e[1]*e[14]*e[11]+e[2]*e[9]*e[15]-e[2]*e[13]*e[11]-e[3]*e[9]*e[14]+e[3]*e[13]*e[10],r[2]=e[1]*e[6]*e[15]-e[1]*e[14]*e[7]-e[2]*e[5]*e[15]+e[2]*e[13]*e[7]+e[3]*e[5]*e[14]-e[3]*e[13]*e[6],r[3]=-e[1]*e[6]*e[11]+e[1]*e[10]*e[7]+e[2]*e[5]*e[11]-e[2]*e[9]*e[7]-e[3]*e[5]*e[10]+e[3]*e[9]*e[6],r[4]=-e[4]*e[10]*e[15]+e[4]*e[14]*e[11]+e[6]*e[8]*e[15]-e[6]*e[12]*e[11]-e[7]*e[8]*e[14]+e[7]*e[12]*e[10],r[5]=e[0]*e[10]*e[15]-e[0]*e[14]*e[11]-e[2]*e[8]*e[15]+e[2]*e[12]*e[11]+e[3]*e[8]*e[14]-e[3]*e[12]*e[10],r[6]=-e[0]*e[6]*e[15]+e[0]*e[14]*e[7]+e[2]*e[4]*e[15]-e[2]*e[12]*e[7]-e[3]*e[4]*e[14]+e[3]*e[12]*e[6],r[7]=e[0]*e[6]*e[11]-e[0]*e[10]*e[7]-e[2]*e[4]*e[11]+e[2]*e[8]*e[7]+e[3]*e[4]*e[10]-e[3]*e[8]*e[6],r[8]=e[4]*e[9]*e[15]-e[4]*e[13]*e[11]-e[5]*e[8]*e[15]+e[5]*e[12]*e[11]+e[7]*e[8]*e[13]-e[7]*e[12]*e[9],r[9]=-e[0]*e[9]*e[15]+e[0]*e[13]*e[11]+e[1]*e[8]*e[15]-e[1]*e[12]*e[11]-e[3]*e[8]*e[13]+e[3]*e[12]*e[9],r[10]=e[0]*e[5]*e[15]-e[0]*e[13]*e[7]-e[1]*e[4]*e[15]+e[1]*e[12]*e[7]+e[3]*e[4]*e[13]-e[3]*e[12]*e[5],r[11]=-e[0]*e[5]*e[11]+e[0]*e[9]*e[7]+e[1]*e[4]*e[11]-e[1]*e[8]*e[7]-e[3]*e[4]*e[9]+e[3]*e[8]*e[5],r[12]=-e[4]*e[9]*e[14]+e[4]*e[13]*e[10]+e[5]*e[8]*e[14]-e[5]*e[12]*e[10]-e[6]*e[8]*e[13]+e[6]*e[12]*e[9],r[13]=e[0]*e[9]*e[14]-e[0]*e[13]*e[10]-e[1]*e[8]*e[14]+e[1]*e[12]*e[10]+e[2]*e[8]*e[13]-e[2]*e[12]*e[9],r[14]=-e[0]*e[5]*e[14]+e[0]*e[13]*e[6]+e[1]*e[4]*e[14]-e[1]*e[12]*e[6]-e[2]*e[4]*e[13]+e[2]*e[12]*e[5],r[15]=e[0]*e[5]*e[10]-e[0]*e[9]*e[6]-e[1]*e[4]*e[10]+e[1]*e[8]*e[6]+e[2]*e[4]*e[9]-e[2]*e[8]*e[5];for(var n=e[0]*r[0]+e[1]*r[4]+e[2]*r[8]+e[3]*r[12],s=0;s<16;s++)r[s]/=n;return i},y.transpose=function(t,i){i=i||new y;var e=t.m,r=i.m;return r[0]=e[0],r[1]=e[4],r[2]=e[8],r[3]=e[12],r[4]=e[1],r[5]=e[5],r[6]=e[9],r[7]=e[13],r[8]=e[2],r[9]=e[6],r[10]=e[10],r[11]=e[14],r[12]=e[3],r[13]=e[7],r[14]=e[11],r[15]=e[15],i},y.multiply=function(t,i,e){e=e||new y;var r=t.m,n=i.m,s=e.m;return s[0]=r[0]*n[0]+r[1]*n[4]+r[2]*n[8]+r[3]*n[12],s[1]=r[0]*n[1]+r[1]*n[5]+r[2]*n[9]+r[3]*n[13],s[2]=r[0]*n[2]+r[1]*n[6]+r[2]*n[10]+r[3]*n[14],s[3]=r[0]*n[3]+r[1]*n[7]+r[2]*n[11]+r[3]*n[15],s[4]=r[4]*n[0]+r[5]*n[4]+r[6]*n[8]+r[7]*n[12],s[5]=r[4]*n[1]+r[5]*n[5]+r[6]*n[9]+r[7]*n[13],s[6]=r[4]*n[2]+r[5]*n[6]+r[6]*n[10]+r[7]*n[14],s[7]=r[4]*n[3]+r[5]*n[7]+r[6]*n[11]+r[7]*n[15],s[8]=r[8]*n[0]+r[9]*n[4]+r[10]*n[8]+r[11]*n[12],s[9]=r[8]*n[1]+r[9]*n[5]+r[10]*n[9]+r[11]*n[13],s[10]=r[8]*n[2]+r[9]*n[6]+r[10]*n[10]+r[11]*n[14],s[11]=r[8]*n[3]+r[9]*n[7]+r[10]*n[11]+r[11]*n[15],s[12]=r[12]*n[0]+r[13]*n[4]+r[14]*n[8]+r[15]*n[12],s[13]=r[12]*n[1]+r[13]*n[5]+r[14]*n[9]+r[15]*n[13],s[14]=r[12]*n[2]+r[13]*n[6]+r[14]*n[10]+r[15]*n[14],s[15]=r[12]*n[3]+r[13]*n[7]+r[14]*n[11]+r[15]*n[15],e},y.identity=function(t){t=t||new y;var i=t.m;return i[0]=i[5]=i[10]=i[15]=1,i[1]=i[2]=i[3]=i[4]=i[6]=i[7]=i[8]=i[9]=i[11]=i[12]=i[13]=i[14]=0,t},y.perspective=function(t,i,e,r,n){var s=Math.tan(t*Math.PI/360)*e,l=s*i;return y.frustum(-l,l,-s,s,e,r,n)},y.frustum=function(t,i,e,r,n,s,l){l=l||new y;var h=l.m;return h[0]=2*n/(i-t),h[1]=0,h[2]=(i+t)/(i-t),h[3]=0,h[4]=0,h[5]=2*n/(r-e),h[6]=(r+e)/(r-e),h[7]=0,h[8]=0,h[9]=0,h[10]=-(s+n)/(s-n),h[11]=-2*s*n/(s-n),h[12]=0,h[13]=0,h[14]=-1,h[15]=0,l},y.ortho=function(t,i,e,r,n,s,l){l=l||new y;var h=l.m;return h[0]=2/(i-t),h[1]=0,h[2]=0,h[3]=-(i+t)/(i-t),h[4]=0,h[5]=2/(r-e),h[6]=0,h[7]=-(r+e)/(r-e),h[8]=0,h[9]=0,h[10]=-2/(s-n),h[11]=-(s+n)/(s-n),h[12]=0,h[13]=0,h[14]=0,h[15]=1,l},y.scale=function(t,i,e,r){r=r||new y;var n=r.m;return n[0]=t,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=i,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,r},y.translate=function(t,i,e,r){r=r||new y;var n=r.m;return n[0]=1,n[1]=0,n[2]=0,n[3]=t,n[4]=0,n[5]=1,n[6]=0,n[7]=i,n[8]=0,n[9]=0,n[10]=1,n[11]=e,n[12]=0,n[13]=0,n[14]=0,n[15]=1,r},y.rotate=function(t,i,e,r,n){if(!t||!i&&!e&&!r)return y.identity(n);n=n||new y;var s=n.m,l=Math.sqrt(i*i+e*e+r*r);t*=Math.PI/180,i/=l,e/=l,r/=l;var h=Math.cos(t),f=Math.sin(t),d=1-h;return s[0]=i*i*d+h,s[1]=i*e*d-r*f,s[2]=i*r*d+e*f,s[3]=0,s[4]=e*i*d+r*f,s[5]=e*e*d+h,s[6]=e*r*d-i*f,s[7]=0,s[8]=r*i*d-e*f,s[9]=r*e*d+i*f,s[10]=r*r*d+h,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,n},y.lookAt=function(t,i,e,r,n,s,l,h,f,d){d=d||new y;var c=d.m,v=new u(t,i,e),w=new u(r,n,s),x=new u(l,h,f),E=v.subtract(w).unit(),b=x.cross(E).unit(),z=E.cross(b).unit();return c[0]=b.x,c[1]=b.y,c[2]=b.z,c[3]=-b.dot(v),c[4]=z.x,c[5]=z.y,c[6]=z.z,c[7]=-z.dot(v),c[8]=E.x,c[9]=E.y,c[10]=E.z,c[11]=-E.dot(v),c[12]=0,c[13]=0,c[14]=0,c[15]=1,d};function N(){this.unique=[],this.indices=[],this.map={}}N.prototype={add:function(t){var i=JSON.stringify(t);return i in this.map||(this.map[i]=this.unique.length,this.unique.push(t)),this.map[i]}};function G(t,i){this.buffer=null,this.target=t,this.type=i,this.data=[]}G.prototype={compile:function(t){for(var i=[],e=0,r=1e4;e<this.data.length;e+=r)i=Array.prototype.concat.apply(i,this.data.slice(e,e+r));var n=this.data.length?i.length/this.data.length:0;if(n!=Math.round(n))throw new Error("buffer elements not of consistent size, average size is "+n);this.buffer=this.buffer||o.createBuffer(),this.buffer.length=i.length,this.buffer.spacing=n,o.bindBuffer(this.target,this.buffer),o.bufferData(this.target,new this.type(i),t||o.STATIC_DRAW)}};function P(t){t=t||{},this.vertexBuffers={},this.indexBuffers={},this.addVertexBuffer("vertices","gl_Vertex"),t.coords&&this.addVertexBuffer("coords","gl_TexCoord"),t.normals&&this.addVertexBuffer("normals","gl_Normal"),t.colors&&this.addVertexBuffer("colors","gl_Color"),(!("triangles"in t)||t.triangles)&&this.addIndexBuffer("triangles"),t.lines&&this.addIndexBuffer("lines")}P.prototype={addVertexBuffer:function(t,i){var e=this.vertexBuffers[i]=new G(o.ARRAY_BUFFER,Float32Array);e.name=t,this[t]=[]},addIndexBuffer:function(t){this.indexBuffers[t]=new G(o.ELEMENT_ARRAY_BUFFER,Uint16Array),this[t]=[]},compile:function(){for(var t in this.vertexBuffers){var i=this.vertexBuffers[t];i.data=this[i.name],i.compile()}for(var e in this.indexBuffers){var i=this.indexBuffers[e];i.data=this[e],i.compile()}},transform:function(t){if(this.vertices=this.vertices.map(function(e){return t.transformPoint(u.fromArray(e)).toArray()}),this.normals){var i=t.inverse().transpose();this.normals=this.normals.map(function(e){return i.transformVector(u.fromArray(e)).unit().toArray()})}return this.compile(),this},computeNormals:function(){this.normals||this.addVertexBuffer("normals","gl_Normal");for(var t=0;t<this.vertices.length;t++)this.normals[t]=new u;for(var t=0;t<this.triangles.length;t++){var i=this.triangles[t],e=u.fromArray(this.vertices[i[0]]),r=u.fromArray(this.vertices[i[1]]),n=u.fromArray(this.vertices[i[2]]),s=r.subtract(e).cross(n.subtract(e)).unit();this.normals[i[0]]=this.normals[i[0]].add(s),this.normals[i[1]]=this.normals[i[1]].add(s),this.normals[i[2]]=this.normals[i[2]].add(s)}for(var t=0;t<this.vertices.length;t++)this.normals[t]=this.normals[t].unit().toArray();return this.compile(),this},computeWireframe:function(){for(var t=new N,i=0;i<this.triangles.length;i++)for(var e=this.triangles[i],r=0;r<e.length;r++){var n=e[r],s=e[(r+1)%e.length];t.add([Math.min(n,s),Math.max(n,s)])}return this.lines||this.addIndexBuffer("lines"),this.lines=t.unique,this.compile(),this},getAABB:function(){var t={min:new u(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)};t.max=t.min.negative();for(var i=0;i<this.vertices.length;i++){var e=u.fromArray(this.vertices[i]);t.min=u.min(t.min,e),t.max=u.max(t.max,e)}return t},getBoundingSphere:function(){for(var t=this.getAABB(),i={center:t.min.add(t.max).divide(2),radius:0},e=0;e<this.vertices.length;e++)i.radius=Math.max(i.radius,u.fromArray(this.vertices[e]).subtract(i.center).length());return i}},P.plane=function(t){t=t||{};for(var i=new P(t),e=t.detailX||t.detail||1,r=t.detailY||t.detail||1,n=t.width||2,s=t.height||2,l=0;l<=r;l++)for(var h=l/r,f=0;f<=e;f++){var d=f/e;if(i.vertices.push([(d-.5)*n,(h-.5)*s,0]),i.coords&&i.coords.push([d,h]),i.normals&&i.normals.push([0,0,1]),f<e&&l<r){var c=f+l*(e+1);i.triangles.push([c,c+1,c+e+1]),i.triangles.push([c+e+1,c+1,c+e+2])}}return i.compile(),i};var k=[[0,4,2,6,-1,0,0],[1,3,5,7,1,0,0],[0,1,4,5,0,-1,0],[2,6,3,7,0,1,0],[0,2,1,3,0,0,-1],[4,5,6,7,0,0,1]];function W(t){return new u((t&1)*2-1,(t&2)-1,(t&4)/2-1)}P.cube=function(t){for(var i=new P(t),e=t&&t.width||2,r=t&&t.height||2,n=t&&t.depth||2,s=0;s<k.length;s++){for(var l=k[s],h=s*4,f=0;f<4;f++){var d=l[f];const c=W(d).toArray();c[0]*=e/2,c[1]*=r/2,c[2]*=n/2,i.vertices.push(c),i.coords&&i.coords.push([f&1,(f&2)/2]),i.normals&&i.normals.push(l.slice(4,7))}i.triangles.push([h,h+1,h+2]),i.triangles.push([h+2,h+1,h+3])}return i.compile(),i},P.sphere=function(t){function i(z,ee,le){return f?[z,le,ee]:[z,ee,le]}function e(z){return z+(z-z*z)/2}t=t||{};for(var r=new P(t),n=new N,s=t.detail||6,l=0;l<8;l++)for(var h=W(l),f=h.x*h.y*h.z>0,d=[],c=0;c<=s;c++){for(var v=0;c+v<=s;v++){var w=c/s,x=v/s,E=(s-c-v)/s,b={vertex:new u(e(w),e(x),e(E)).unit().multiply(h).toArray()};r.coords&&(b.coord=h.y>0?[1-w,E]:[E,1-w]),d.push(n.add(b))}if(c>0)for(var v=0;c+v<=s;v++){var w=(c-1)*(s+1)+(c-1-(c-1)*(c-1))/2+v,x=c*(s+1)+(c-c*c)/2+v;r.triangles.push(i(d[w],d[w+1],d[x])),c+v<s&&r.triangles.push(i(d[x],d[w+1],d[x+1]))}}return r.vertices=n.unique.map(function(z){return z.vertex}),r.coords&&(r.coords=n.unique.map(function(z){return z.coord})),r.normals&&(r.normals=r.vertices),r.compile(),r},P.load=function(t,i){i=i||{},"coords"in i||(i.coords=!!t.coords),"normals"in i||(i.normals=!!t.normals),"colors"in i||(i.colors=!!t.colors),"triangles"in i||(i.triangles=!!t.triangles),"lines"in i||(i.lines=!!t.lines);var e=new P(i);return e.vertices=t.vertices,e.coords&&(e.coords=t.coords),e.normals&&(e.normals=t.normals),e.colors&&(e.colors=t.colors),e.triangles&&(e.triangles=t.triangles),e.lines&&(e.lines=t.lines),e.compile(),e};function I(t,i,e){this.t=arguments.length?t:Number.MAX_VALUE,this.hit=i,this.normal=e}I.prototype={mergeWith:function(t){t.t>0&&t.t<this.t&&(this.t=t.t,this.hit=t.hit,this.normal=t.normal)}};function O(){var t=o.getParameter(o.VIEWPORT),i=o.modelviewMatrix.m,e=new u(i[0],i[4],i[8]),r=new u(i[1],i[5],i[9]),n=new u(i[2],i[6],i[10]),s=new u(i[3],i[7],i[11]);this.eye=new u(-s.dot(e),-s.dot(r),-s.dot(n));var l=t[0],h=l+t[2],f=t[1],d=f+t[3];this.ray00=o.unProject(l,f,1).subtract(this.eye),this.ray10=o.unProject(h,f,1).subtract(this.eye),this.ray01=o.unProject(l,d,1).subtract(this.eye),this.ray11=o.unProject(h,d,1).subtract(this.eye),this.viewport=t}O.prototype={getRayForPixel:function(t,i){t=(t-this.viewport[0])/this.viewport[2],i=1-(i-this.viewport[1])/this.viewport[3];var e=u.lerp(this.ray00,this.ray10,t),r=u.lerp(this.ray01,this.ray11,t);return u.lerp(e,r,i).unit()}},O.hitTestBox=function(t,i,e,r){var n=e.subtract(t).divide(i),s=r.subtract(t).divide(i),l=u.min(n,s),h=u.max(n,s),f=l.max(),d=h.min();if(f>0&&f<d){var c=1e-6,v=t.add(i.multiply(f));return e=e.add(c),r=r.subtract(c),new I(f,v,new u((v.x>r.x)-(v.x<e.x),(v.y>r.y)-(v.y<e.y),(v.z>r.z)-(v.z<e.z)))}return null},O.hitTestSphere=function(t,i,e,r){var n=t.subtract(e),s=i.dot(i),l=2*i.dot(n),h=n.dot(n)-r*r,f=l*l-4*s*h;if(f>0){var d=(-l-Math.sqrt(f))/(2*s),c=t.add(i.multiply(d));return new I(d,c,c.subtract(e).divide(r))}return null},O.hitTestTriangle=function(t,i,e,r,n){var s=r.subtract(e),l=n.subtract(e),h=s.cross(l).unit(),f=h.dot(e.subtract(t))/h.dot(i);if(f>0){var d=t.add(i.multiply(f)),c=d.subtract(e),v=l.dot(l),w=l.dot(s),x=l.dot(c),E=s.dot(s),b=s.dot(c),z=v*E-w*w,ee=(E*x-w*b)/z,le=(v*b-w*x)/z;if(ee>=0&&le>=0&&ee+le<=1)return new I(f,d,h)}return null};function re(t,i,e){let r;for(;(r=t.exec(i))!=null;)e(r)}var $="LIGHTGL";function ie(t,i){function e(v){var w=document.getElementById(v);return w?w.text:v}t=e(t),i=e(i);var r="    uniform mat3 gl_NormalMatrix;    uniform mat4 gl_ModelViewMatrix;    uniform mat4 gl_ProjectionMatrix;    uniform mat4 gl_ModelViewProjectionMatrix;    uniform mat4 gl_ModelViewMatrixInverse;    uniform mat4 gl_ProjectionMatrixInverse;    uniform mat4 gl_ModelViewProjectionMatrixInverse;  ",n=r+"    attribute vec4 gl_Vertex;    attribute vec4 gl_TexCoord;    attribute vec3 gl_Normal;    attribute vec4 gl_Color;    vec4 ftransform() {      return gl_ModelViewProjectionMatrix * gl_Vertex;    }  ",s="    precision highp float;  "+r,l=t+i,h={};re(/\b(gl_[^;]*)\b;/g,r,function(v){var w=v[1];if(l.indexOf(w)!=-1){var x=w.replace(/[a-z_]/g,"");h[x]=$+w}}),l.indexOf("ftransform")!=-1&&(h.MVPM=$+"gl_ModelViewProjectionMatrix"),this.usedMatrices=h;function f(v,w){var x={},E=/^((\s*\/\/.*\n|\s*#extension.*\n)+)[^]*$/.exec(w);return w=E?E[1]+v+w.substr(E[1].length):v+w,re(/\bgl_\w+\b/g,v,function(b){b in x||(w=w.replace(new RegExp("\\b"+b+"\\b","g"),$+b),x[b]=!0)}),w}t=f(n,t),i=f(s,i);function d(v,w){var x=o.createShader(v);if(o.shaderSource(x,w),o.compileShader(x),!o.getShaderParameter(x,o.COMPILE_STATUS))throw new Error("compile error: "+o.getShaderInfoLog(x));return x}if(this.program=o.createProgram(),o.attachShader(this.program,d(o.VERTEX_SHADER,t)),o.attachShader(this.program,d(o.FRAGMENT_SHADER,i)),o.linkProgram(this.program),!o.getProgramParameter(this.program,o.LINK_STATUS))throw new Error("link error: "+o.getProgramInfoLog(this.program));this.attributes={},this.uniformLocations={};var c={};re(/uniform\s+sampler(1D|2D|3D|Cube)\s+(\w+)\s*;/g,t+i,function(v){c[v[2]]=1}),this.isSampler=c}function de(t){var i=Object.prototype.toString.call(t);return i=="[object Array]"||i=="[object Float32Array]"}function oe(t){var i=Object.prototype.toString.call(t);return i=="[object Number]"||i=="[object Boolean]"}new y,new y,ie.prototype={uniforms:function(t){o.useProgram(this.program);for(var i in t){var e=this.uniformLocations[i]||o.getUniformLocation(this.program,i);if(e){this.uniformLocations[i]=e;var r=t[i];if(r instanceof u?r=[r.x,r.y,r.z]:r instanceof y&&(r=r.m),de(r))switch(r.length){case 1:o.uniform1fv(e,new Float32Array(r));break;case 2:o.uniform2fv(e,new Float32Array(r));break;case 3:o.uniform3fv(e,new Float32Array(r));break;case 4:o.uniform4fv(e,new Float32Array(r));break;case 9:o.uniformMatrix3fv(e,!1,new Float32Array([r[0],r[3],r[6],r[1],r[4],r[7],r[2],r[5],r[8]]));break;case 16:o.uniformMatrix4fv(e,!1,new Float32Array([r[0],r[4],r[8],r[12],r[1],r[5],r[9],r[13],r[2],r[6],r[10],r[14],r[3],r[7],r[11],r[15]]));break;default:throw new Error(`don't know how to load uniform "`+i+'" of length '+r.length)}else if(oe(r))(this.isSampler[i]?o.uniform1i:o.uniform1f).call(o,e,r);else throw new Error('attempted to set uniform "'+i+'" to invalid value '+r)}}return this},draw:function(t,i){this.drawBuffers(t.vertexBuffers,t.indexBuffers[i==o.LINES?"lines":"triangles"],arguments.length<2?o.TRIANGLES:i)},drawBuffers:function(t,i,e){var r=this.usedMatrices,n=o.modelviewMatrix,s=o.projectionMatrix,l=r.MVMI||r.NM?n.inverse():null,h=r.PMI?s.inverse():null,f=r.MVPM||r.MVPMI?s.multiply(n):null,d={};if(r.MVM&&(d[r.MVM]=n),r.MVMI&&(d[r.MVMI]=l),r.PM&&(d[r.PM]=s),r.PMI&&(d[r.PMI]=h),r.MVPM&&(d[r.MVPM]=f),r.MVPMI&&(d[r.MVPMI]=f.inverse()),r.NM){var c=l.m;d[r.NM]=[c[0],c[4],c[8],c[1],c[5],c[9],c[2],c[6],c[10]]}this.uniforms(d);var v=0;for(var w in t){var x=t[w],E=this.attributes[w]||o.getAttribLocation(this.program,w.replace(/^(gl_.*)$/,$+"$1"));E==-1||!x.buffer||(this.attributes[w]=E,o.bindBuffer(o.ARRAY_BUFFER,x.buffer),o.enableVertexAttribArray(E),o.vertexAttribPointer(E,x.buffer.spacing,o.FLOAT,!1,0,0),v=x.buffer.length/x.buffer.spacing)}for(var w in this.attributes)w in t||o.disableVertexAttribArray(this.attributes[w]);return v&&(!i||i.buffer)&&(i?(o.bindBuffer(o.ELEMENT_ARRAY_BUFFER,i.buffer),o.drawElements(e,i.buffer.length,o.UNSIGNED_SHORT,0)):o.drawArrays(e,0,v)),this}};function C(t,i,e){e=e||{},this.id=o.createTexture(),this.width=t,this.height=i,this.format=e.format||o.RGBA,this.type=e.type||o.UNSIGNED_BYTE;var r=e.filter||e.magFilter||o.LINEAR,n=e.filter||e.minFilter||o.LINEAR;if(this.type===o.FLOAT){if(!C.canUseFloatingPointTextures())throw new Error("OES_texture_float is required but not supported");if((n!==o.NEAREST||r!==o.NEAREST)&&!C.canUseFloatingPointLinearFiltering())throw new Error("OES_texture_float_linear is required but not supported")}else if(this.type===o.HALF_FLOAT_OES){if(!C.canUseHalfFloatingPointTextures())throw new Error("OES_texture_half_float is required but not supported");if((n!==o.NEAREST||r!==o.NEAREST)&&!C.canUseHalfFloatingPointLinearFiltering())throw new Error("OES_texture_half_float_linear is required but not supported")}o.bindTexture(o.TEXTURE_2D,this.id),o.pixelStorei(o.UNPACK_FLIP_Y_WEBGL,1),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MAG_FILTER,r),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_MIN_FILTER,n),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_S,e.wrap||e.wrapS||o.CLAMP_TO_EDGE),o.texParameteri(o.TEXTURE_2D,o.TEXTURE_WRAP_T,e.wrap||e.wrapT||o.CLAMP_TO_EDGE),o.texImage2D(o.TEXTURE_2D,0,this.format,t,i,0,this.format,this.type,null)}var q,X,ne;C.prototype={bind:function(t){o.activeTexture(o.TEXTURE0+(t||0)),o.bindTexture(o.TEXTURE_2D,this.id)},unbind:function(t){o.activeTexture(o.TEXTURE0+(t||0)),o.bindTexture(o.TEXTURE_2D,null)},canDrawTo:function(){q=q||o.createFramebuffer(),o.bindFramebuffer(o.FRAMEBUFFER,q),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this.id,0);var t=o.checkFramebufferStatus(o.FRAMEBUFFER)==o.FRAMEBUFFER_COMPLETE;return o.bindFramebuffer(o.FRAMEBUFFER,null),t},drawTo:function(t){var i=o.getParameter(o.VIEWPORT);if(q=q||o.createFramebuffer(),X=X||o.createRenderbuffer(),o.bindFramebuffer(o.FRAMEBUFFER,q),o.bindRenderbuffer(o.RENDERBUFFER,X),(this.width!=X.width||this.height!=X.height)&&(X.width=this.width,X.height=this.height,o.renderbufferStorage(o.RENDERBUFFER,o.DEPTH_COMPONENT16,this.width,this.height)),o.framebufferTexture2D(o.FRAMEBUFFER,o.COLOR_ATTACHMENT0,o.TEXTURE_2D,this.id,0),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,X),o.checkFramebufferStatus(o.FRAMEBUFFER)!=o.FRAMEBUFFER_COMPLETE)throw new Error("Rendering to this texture is not supported (incomplete framebuffer)");o.viewport(0,0,this.width,this.height),t(),o.bindFramebuffer(o.FRAMEBUFFER,null),o.bindRenderbuffer(o.RENDERBUFFER,null),o.viewport(i[0],i[1],i[2],i[3])},swapWith:function(t){var i;i=t.id,t.id=this.id,this.id=i,i=t.width,t.width=this.width,this.width=i,i=t.height,t.height=this.height,this.height=i}},C.fromImage=function(t,i){i=i||{};var e=new C(t.width,t.height,i);try{o.texImage2D(o.TEXTURE_2D,0,e.format,e.format,e.type,t)}catch{throw location.protocol=="file:"?new Error('image not loaded for security reasons (serve this page over "http://" instead)'):new Error("image not loaded for security reasons (image must originate from the same domain as this page or use Cross-Origin Resource Sharing)")}return i.minFilter&&i.minFilter!=o.NEAREST&&i.minFilter!=o.LINEAR&&o.generateMipmap(o.TEXTURE_2D),e},C.fromURL=function(t,i){ne=ne||function(){var s=document.createElement("canvas").getContext("2d");s.canvas.width=s.canvas.height=128;for(var l=0;l<s.canvas.height;l+=16)for(var h=0;h<s.canvas.width;h+=16)s.fillStyle=(h^l)&16?"#FFF":"#DDD",s.fillRect(h,l,16,16);return s.canvas}();var e=C.fromImage(ne,i),r=new Image,n=o;return r.onload=function(){n.makeCurrent(),C.fromImage(r,i).swapWith(e)},r.src=t,e},C.canUseFloatingPointTextures=function(){return!!o.getExtension("OES_texture_float")},C.canUseFloatingPointLinearFiltering=function(){return!!o.getExtension("OES_texture_float_linear")},C.canUseHalfFloatingPointTextures=function(){return!!o.getExtension("OES_texture_half_float")},C.canUseHalfFloatingPointLinearFiltering=function(){return!!o.getExtension("OES_texture_half_float_linear")};function u(t,i,e){this.x=t||0,this.y=i||0,this.z=e||0}return u.prototype={negative:function(){return new u(-this.x,-this.y,-this.z)},add:function(t){return t instanceof u?new u(this.x+t.x,this.y+t.y,this.z+t.z):new u(this.x+t,this.y+t,this.z+t)},subtract:function(t){return t instanceof u?new u(this.x-t.x,this.y-t.y,this.z-t.z):new u(this.x-t,this.y-t,this.z-t)},multiply:function(t){return t instanceof u?new u(this.x*t.x,this.y*t.y,this.z*t.z):new u(this.x*t,this.y*t,this.z*t)},divide:function(t){return t instanceof u?new u(this.x/t.x,this.y/t.y,this.z/t.z):new u(this.x/t,this.y/t,this.z/t)},equals:function(t){return this.x==t.x&&this.y==t.y&&this.z==t.z},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},cross:function(t){return new u(this.y*t.z-this.z*t.y,this.z*t.x-this.x*t.z,this.x*t.y-this.y*t.x)},length:function(){return Math.sqrt(this.dot(this))},unit:function(){return this.divide(this.length())},min:function(){return Math.min(Math.min(this.x,this.y),this.z)},max:function(){return Math.max(Math.max(this.x,this.y),this.z)},toAngles:function(){return{theta:Math.atan2(this.z,this.x),phi:Math.asin(this.y/this.length())}},angleTo:function(t){return Math.acos(this.dot(t)/(this.length()*t.length()))},toArray:function(t){return[this.x,this.y,this.z].slice(0,t||3)},clone:function(){return new u(this.x,this.y,this.z)},init:function(t,i,e){return this.x=t,this.y=i,this.z=e,this}},u.negative=function(t,i){return i.x=-t.x,i.y=-t.y,i.z=-t.z,i},u.add=function(t,i,e){return i instanceof u?(e.x=t.x+i.x,e.y=t.y+i.y,e.z=t.z+i.z):(e.x=t.x+i,e.y=t.y+i,e.z=t.z+i),e},u.subtract=function(t,i,e){return i instanceof u?(e.x=t.x-i.x,e.y=t.y-i.y,e.z=t.z-i.z):(e.x=t.x-i,e.y=t.y-i,e.z=t.z-i),e},u.multiply=function(t,i,e){return i instanceof u?(e.x=t.x*i.x,e.y=t.y*i.y,e.z=t.z*i.z):(e.x=t.x*i,e.y=t.y*i,e.z=t.z*i),e},u.divide=function(t,i,e){return i instanceof u?(e.x=t.x/i.x,e.y=t.y/i.y,e.z=t.z/i.z):(e.x=t.x/i,e.y=t.y/i,e.z=t.z/i),e},u.cross=function(t,i,e){return e.x=t.y*i.z-t.z*i.y,e.y=t.z*i.x-t.x*i.z,e.z=t.x*i.y-t.y*i.x,e},u.unit=function(t,i){var e=t.length();return i.x=t.x/e,i.y=t.y/e,i.z=t.z/e,i},u.fromAngles=function(t,i){return new u(Math.cos(t)*Math.cos(i),Math.sin(i),Math.sin(t)*Math.cos(i))},u.randomDirection=function(){return u.fromAngles(Math.random()*Math.PI*2,Math.asin(Math.random()*2-1))},u.min=function(t,i){return new u(Math.min(t.x,i.x),Math.min(t.y,i.y),Math.min(t.z,i.z))},u.max=function(t,i){return new u(Math.max(t.x,i.x),Math.max(t.y,i.y),Math.max(t.z,i.z))},u.lerp=function(t,i,e){return i.subtract(t).multiply(e).add(t)},u.fromArray=function(t){return new u(t[0],t[1],t[2])},u.angleBetween=function(t,i){return t.angleTo(i)},a}();const we=new m.Vector(0,-4,0);class ce{constructor(a,p){console.log("center : "+a.x+" , "+a.y+" , "+a.z),this.center=new m.Vector(a.x,a.y,a.z),this.oldCenter=new m.Vector(a.x,a.y,a.z),this.radius=p,this.cinematic=!1,this.velocity=new m.Vector(0,0,0),this.acceleration=new m.Vector(0,0,0),this.mass=4/3*Math.PI*Math.pow(p,3)*1e3,this.invMass=1/this.mass,this.radiusSquared=p*p,this.mesh=m.Mesh.sphere({detail:10})}update(a,p){if(this.cinematic)this.velocity=new m.Vector(0,0,0);else{this.oldCenter=new m.Vector(this.center.x,this.center.y,this.center.z);const g=Math.max(0,Math.min(1,(this.radius-this.center.y)/(2*this.radius))),T=we.multiply(-1.35*this.mass*g),A=this.velocity.unit().multiply(-1e3*this.radiusSquared*g*this.velocity.dot(this.velocity));this.addForce(A),this.addForce(T),this.addForce(we.multiply(this.mass)),this.velocity=this.velocity.add(this.acceleration.multiply(a)),this.acceleration=new m.Vector(0,0,0),this.center=this.center.add(this.velocity.multiply(a)),this.center.y<this.radius-p.y&&(this.center.y=this.radius-1,this.velocity.y=Math.abs(this.velocity.y)*.7)}}addForce(a){this.cinematic?console.warn("Trying to add force to a cinematic sphere."):this.acceleration=this.acceleration.add(a.multiply(this.invMass))}move(a){this.oldCenter=new m.Vector(this.center.x,this.center.y,this.center.z),this.center=new m.Vector(a.x,a.y,a.z),this.cinematic||console.warn("Moving a non cinematic sphere.")}}function Me(o=0,a=1){const p=1-Math.random(),g=Math.random();return Math.sqrt(-2*Math.log(p))*Math.cos(2*Math.PI*g)*a+o}const J=new m.Vector(1e3,0,0),be=.5,Se=1,Ee=2*Math.PI*Se,he=class he{constructor(a){this.startingPoint=new m.Vector(a.x,a.y,a.z),this.center=new m.Vector(a.x,a.y,a.z),this.force=new m.Vector(0,0,155+Me(0,20));const p=.25,g=.15;this.body=new ce(a,p),this.leftArm=new ce(J,g),this.rightArm=new ce(J,g),this.leftFoot=new ce(J,g),this.rightFoot=new ce(J,g),this.body.cinematic=!he.useGravity,this.leftArm.cinematic=!0,this.rightArm.cinematic=!0,this.leftFoot.cinematic=!0,this.rightFoot.cinematic=!0,this.spheres=[this.body,this.leftArm,this.rightArm,this.leftFoot,this.rightFoot]}getArmOffset(a,p){return new m.Vector(0,Math.cos(Ee*a+p),Math.sin(Ee*a+p)).multiply(be)}update(a,p,g){if(he.swimming){this.body.addForce(this.force);const T=this.getArmOffset(p,0),A=this.getArmOffset(p,Math.PI),M=this.getArmOffset(p*2,0),D=this.getArmOffset(p*2,Math.PI);this.rightArm.move(this.body.center.add(T).add(new m.Vector(.3,0,0))),this.leftArm.move(this.body.center.add(A).add(new m.Vector(-.3,0,0))),this.rightFoot.move(this.body.center.add(new m.Vector(.15,M.y*.5,-1))),this.leftFoot.move(this.body.center.add(new m.Vector(-.15,D.y*.5,-1)))}else this.rightArm.move(J),this.leftArm.move(J),this.rightFoot.move(J),this.leftFoot.move(J);for(let T of this.spheres)T.update(a,g)}};me(he,"useGravity",!1),me(he,"swimming",!1);let L=he;function H(o,a,p=null){this.gl=o,this.areaConservationEnabled=!0,this.sqrt_2_PI=Math.sqrt(2*Math.PI),this.spheres=[];var g="    varying vec2 coord;    void main() {      coord = gl_Vertex.xy * 0.5 + 0.5;      gl_Position = vec4(gl_Vertex.xyz, 1.0);    }  ";if(this.reset(a,p),!m.Texture.canUseFloatingPointTextures())throw new Error("This demo requires the OES_texture_float extension");this.dropShader=new m.Shader(g,"    const float PI = 3.141592653589793;    uniform sampler2D texture;    uniform vec2 center;    uniform vec3 poolSize;    uniform float radius;    uniform float strength;    varying vec2 coord;    void main() {      /* get vertex info */      vec4 info = texture2D(texture, coord);            /* add the drop to the height */      float drop = max(0.0, 1.0 - length(center * 0.5 + 0.5 - coord) / (radius / poolSize.z));      drop = 0.5 - cos(drop * PI) * 0.5;      info.r += drop * strength;            gl_FragColor = info;    }  "),this.updateShader=new m.Shader(g,`
    uniform sampler2D texture;
    uniform vec2 delta;
    uniform float wr;
    uniform float prev_wr;
    uniform float sqrt_2_PI;
    uniform vec3 poolSize;
    varying vec2 coord;
    float gaussian(float x, float mean, float std) {
      return exp(-(x - mean) * (x - mean) / (2.*std*std)) / (std * sqrt_2_PI);
    }
    void main() {
      /* get vertex info */
      vec4 info = texture2D(texture, coord);
      
      /* calculate average neighbor height */
      vec2 dx = vec2(delta.x, 0.0);
      vec2 dy = vec2(0.0, delta.y);
      float average = (
        texture2D(texture, coord - dx).r +
        texture2D(texture, coord - dy).r +
        texture2D(texture, coord + dx).r +
        texture2D(texture, coord + dy).r
      ) * 0.25;
      
      /* change the velocity to move toward the average */
      info.g += (average - info.r) * 2.0;
      
      /* attenuate the velocity a little so waves do not last forever */
      info.g *= 0.98;/*TODO parametriser Ã§a*/
      
      /* move the vertex along the velocity */
      info.r += info.g;
      
      float z = poolSize.z * coord.y;
      if (true || abs(z - wr) < 1.){ 
        info.r += .05 * gaussian(z, wr, .4);
        info.r -= .05 * gaussian(z, prev_wr, .4);
        
        
      }
  
  gl_FragColor = info; 
} 
`),this.normalShader=new m.Shader(g,"    uniform sampler2D texture;    uniform vec2 delta;    varying vec2 coord;    void main() {      /* get vertex info */      vec4 info = texture2D(texture, coord);            /* update the normal */      vec3 dx = vec3(delta.x, texture2D(texture, vec2(coord.x + delta.x, coord.y)).r - info.r, 0.0);      vec3 dy = vec3(0.0, texture2D(texture, vec2(coord.x, coord.y + delta.y)).r - info.r, delta.y);      info.ba = normalize(cross(dy, dx)).xz;            gl_FragColor = info;    }  "),this.sphereShader=new m.Shader(g,"    uniform sampler2D texture;    uniform vec3 oldCenter;    uniform vec3 newCenter;    uniform float radius;    uniform vec3 poolSize;    varying vec2 coord;        float volumeInSphere(vec3 center) {      vec3 toCenter = vec3(coord.x * 2.0 - 1.0, 0.0, coord.y * 2.0 - 1.0) - center;      toCenter = vec3((coord.x - 0.5) * poolSize.x, 0.0, (coord.y - 0.5) * poolSize.z) - center;      float t = length(toCenter) / radius;      float dy = exp(-pow(t * 1.5, 6.0));      float ymin = min(0.0, center.y - dy);      float ymax = min(max(0.0, center.y + dy), ymin + 2.0 * dy);      return (ymax - ymin) * 0.1;    }        void main() {      /* get vertex info */      vec4 info = texture2D(texture, coord);            /* add the old volume */      info.r += volumeInSphere(oldCenter);            /* subtract the new volume */      info.r -= volumeInSphere(newCenter);            gl_FragColor = info;    }  ")}H.prototype.reset=function(o,a=null){this.WR_position=1e5,this.prev_WR_position=0,a!==null?(console.log("resolution.y : "+a.y),this.W=Math.round(a.x),this.H=Math.round(a.y),console.log("Using custom resolution:",this.W,this.H)):(this.W=256,this.H=256),this.plane=m.Mesh.plane({detail:255,width:o.x,height:o.z}),this.delta=new m.Vector(1/this.W,1/this.H);const p=this.gl;this.textureA&&p.deleteTexture(this.textureA.id),this.textureB&&p.deleteTexture(this.textureB.id),this.textureA=new m.Texture(this.W,this.H,{type:this.gl.FLOAT,filter:g}),this.textureB=new m.Texture(this.W,this.H,{type:this.gl.FLOAT,filter:g}),this.areaConservationTexture=new m.Texture(this.W,this.H,{type:this.gl.FLOAT,filter:g}),this.showAreaConservedGrid=!1,this.showProjectionGrid=!1,this.poolSize=o;var g=m.Texture.canUseFloatingPointLinearFiltering()?this.gl.LINEAR:this.gl.NEAREST;(!this.textureA.canDrawTo()||!this.textureB.canDrawTo())&&m.Texture.canUseHalfFloatingPointTextures()&&(console.log("No draw"),g=m.Texture.canUseHalfFloatingPointLinearFiltering()?this.gl.LINEAR:this.gl.NEAREST,this.textureA=new m.Texture(this.W,this.H,{type:this.gl.FLOAT,filter:g}),this.textureB=new m.Texture(this.W,this.H,{type:this.gl.FLOAT,filter:g}))};H.prototype.addDrop=function(o,a,p,g){var T=this;this.textureB.drawTo(function(){T.textureA.bind(),T.dropShader.uniforms({center:[o,a],radius:p,strength:g,poolSize:[T.poolSize.x,T.poolSize.y,T.poolSize.z]}).draw(T.plane)}),this.textureB.swapWith(this.textureA)};H.prototype.addSwimmer=function(o){for(let a of o.spheres)this.addSphere(a)};H.prototype.addSphere=function(o){this.spheres.push(o)};H.prototype.updateSpheres=function(o){this.prev_WR_position=this.WR_position,this.WR_position+=o*2.1;for(let p=0;p<this.spheres.length;p++){const g=this.spheres[p];this.moveSphere(g.oldCenter,g.center,g.radius)}};H.prototype.moveSphere=function(o,a,p){var g=this;this.textureB.drawTo(function(){g.textureA.bind(),g.sphereShader.uniforms({oldCenter:o,newCenter:a,radius:p,poolSize:[g.poolSize.x,g.poolSize.y,g.poolSize.z]}).draw(g.plane)}),this.textureB.swapWith(this.textureA)};H.prototype.stepSimulation=function(){var o=this;this.textureB.drawTo(function(){o.textureA.bind(),o.updateShader.uniforms({delta:[o.delta.x,o.delta.y],wr:o.WR_position,prev_wr:o.prev_WR_position,poolSize:[o.poolSize.x,o.poolSize.y,o.poolSize.z],sqrt_2_PI:o.sqrt_2_PI}).draw(o.plane)}),this.textureB.swapWith(this.textureA),this.updateAreaConservation()};H.prototype.updateNormals=function(){var o=this;this.textureB.drawTo(function(){o.textureA.bind(),o.normalShader.uniforms({delta:[o.delta.x,o.delta.y]}).draw(o.plane)}),this.textureB.swapWith(this.textureA)};H.prototype.setAreaConservation=function(o){this.areaConservationEnabled=o};H.prototype.updateAreaConservation=function(){if(!this.areaConservationEnabled)return;var o,a,p;if(this.textureA.type===this.gl.FLOAT)o=this.gl.FLOAT,a=Float32Array,p="WEBGL_color_buffer_float";else if(this.textureA.type===this.gl.HALF_FLOAT_OES)o=this.gl.HALF_FLOAT_OES,a=Uint16Array,p="EXT_color_buffer_half_float";else{console.warn("Unsupported texture type for reading");return}if(!this.gl.getExtension(p)){console.warn(p+" not available; cannot read pixels");return}this.fb||(this.fb=this.gl.createFramebuffer()),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.fb),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.textureA.id,0);const g=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);if(g!==this.gl.FRAMEBUFFER_COMPLETE){console.error("Framebuffer incomplete: "+g+" for texture type "+this.textureA.type),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null);return}this.gl.pixelStorei(this.gl.PACK_ALIGNMENT,1);const T=new a(this.W*this.H*4),A=new Float32Array(this.W*this.H*4);this.gl.readPixels(0,0,this.W,this.H,this.gl.RGBA,o,T);for(let B=0;B<this.W;B++)A[B*4+1]=1;const M=this.poolSize.x/this.W,D=this.poolSize.z/this.H,Q=M*M,K=D*D;if(this.textureA.type===this.gl.FLOAT){for(let B=0;B<this.H;B+=1)for(let y=0;y<this.W;y+=1){const N=(B*this.W+y)*4,G=((this.H-1-B)*this.W+y)*4,P=A[G],k=A[G+1];if(y+1<this.W){const W=T[N]-T[N+4],I=Math.sqrt(W*W+Q);A[G+4]=P+I}if(B+1<this.H){const W=T[N]-T[N+this.W*4],I=Math.sqrt(W*W+K);A[G-4*this.W+1]=k+I}}this.gl.bindTexture(this.gl.TEXTURE_2D,this.areaConservationTexture.id),this.gl.pixelStorei(this.gl.UNPACK_ALIGNMENT,1),this.gl.texSubImage2D(this.gl.TEXTURE_2D,0,0,0,this.W,this.H,this.gl.RGBA,this.gl.FLOAT,A)}this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindTexture(this.gl.TEXTURE_2D,null)};var te="  const float IOR_AIR = 1.0;  const float IOR_WATER = 1.333;  const vec3 abovewaterColor = vec3(0.25, 1.0, 1.25);  const vec3 underwaterColor = vec3(0.4, 0.9, 1.0);  uniform vec3 light;  uniform vec3 sphereCenter;  uniform float sphereRadius;  uniform sampler2D tiles;  uniform sampler2D causticTex;  uniform sampler2D water;  uniform sampler2D flag;  uniform sampler2D areaConservationTexture;  uniform bool areaConservation;  uniform vec2 flagCenter;  uniform float flagSize;  uniform vec3 poolSize;    vec2 intersectCube(vec3 origin, vec3 ray, vec3 cubeMin, vec3 cubeMax) {    vec3 tMin = (cubeMin - origin) / ray;    vec3 tMax = (cubeMax - origin) / ray;    vec3 t1 = min(tMin, tMax);    vec3 t2 = max(tMin, tMax);    float tNear = max(max(t1.x, t1.y), t1.z);    float tFar = min(min(t2.x, t2.y), t2.z);    return vec2(tNear, tFar);  }    float intersectSphere(vec3 origin, vec3 ray, vec3 sphereCenter, float sphereRadius) {    vec3 toSphere = origin - sphereCenter;    float a = dot(ray, ray);    float b = 2.0 * dot(toSphere, ray);    float c = dot(toSphere, toSphere) - sphereRadius * sphereRadius;    float discriminant = b*b - 4.0*a*c;    if (discriminant > 0.0) {      float t = (-b - sqrt(discriminant)) / (2.0 * a);      if (t > 0.0) return t;    }    return 1.0e6;  }    vec3 getSphereColor(vec3 point) {    vec3 color = vec3(0.5);        /* ambient occlusion with walls */    color *= 1.0 - 0.9 / pow((1.0 + sphereRadius - abs(point.x) / (0.5*poolSize.x)) / sphereRadius, 3.0);    color *= 1.0 - 0.9 / pow((1.0 + sphereRadius - abs(point.z) / (0.5*poolSize.z)) / sphereRadius, 3.0);    color *= 1.0 - 0.9 / pow((point.y + 1.0 + sphereRadius) / sphereRadius, 3.0);        /* caustics */    vec3 sphereNormal = (point - sphereCenter) / sphereRadius;    vec3 refractedLight = refract(-light, vec3(0.0, 1.0, 0.0), IOR_AIR / IOR_WATER);    float diffuse = max(0.0, dot(-refractedLight, sphereNormal)) * 0.5;    vec2 coord = point.xz / poolSize.xz + 0.5;    vec4 info = texture2D(water, coord);    if (point.y < info.r) {      vec4 caustic = texture2D(causticTex, 0.75 * (point.xz - point.y * refractedLight.xz / refractedLight.y) / poolSize.xz + 0.5);      diffuse *= caustic.r * 4.0;    }    color += diffuse;        return color;  }    vec3 getWallColor(vec3 point) {    float scale = 0.5;        vec3 wallColor;    vec3 normal;    if (abs(point.x) > poolSize.x * 0.5 - 0.01) {      wallColor = texture2D(tiles, point.yz * 0.5 + vec2(1.0, 0.5)).rgb;      normal = vec3(-point.x, 0.0, 0.0);    } else if (abs(point.z) > poolSize.z * 0.5 - 0.01) {      wallColor = texture2D(tiles, point.yx * 0.5 + vec2(1.0, 0.5)).rgb;      normal = vec3(0.0, 0.0, -point.z);    } else {      wallColor = texture2D(tiles, point.xz * 0.5 + 0.5).rgb;      normal = vec3(0.0, 1.0, 0.0);    }        /*scale /= length(point) * 10;*/ /* pool ambient occlusion */    scale *= 1.0 - 0.9 / pow(length(point - sphereCenter) / sphereRadius, 4.0); /* sphere ambient occlusion */        /* caustics */    vec3 refractedLight = -refract(-light, vec3(0.0, 1.0, 0.0), IOR_AIR / IOR_WATER);    float diffuse = max(0.0, dot(refractedLight, normal));    vec4 info = texture2D(water, point.xz / poolSize.xz + 0.5);    if (point.y < info.r) {      vec4 caustic = texture2D(causticTex, 0.75 * (point.xz - point.y * refractedLight.xz / refractedLight.y) / poolSize.xz + 0.5);      scale += diffuse * caustic.r * 2.0 * caustic.g;    } else {      /* shadow for the rim of the pool */      vec2 t = intersectCube(point, refractedLight, vec3(-poolSize.x / 2., -poolSize.y, -poolSize.z / 2.), vec3(poolSize.x / 2., poolSize.y, poolSize.z / 2.));      diffuse *= 1.0 / (1.0 + exp(-200.0 / (1.0 + 10.0 * (t.y - t.x)) * (point.y + refractedLight.y * t.y - 2.0 / 12.0)));            scale += diffuse * 0.5;    }        return wallColor * scale;  }";function Z(o,a,p,g){this.water=a,this.gl=o,this.tileTexture=m.Texture.fromImage(document.getElementById("tiles"),{minFilter:this.gl.LINEAR_MIPMAP_LINEAR,wrap:this.gl.REPEAT,format:this.gl.RGB}),this.flagTexture=m.Texture.fromImage(document.getElementById("flag"),{minFilter:this.gl.LINEAR_MIPMAP_LINEAR,wrap:this.gl.REPEAT,format:this.gl.RGB}),this.flagSize=g,this.flagCenter=p,this.lightDir=new m.Vector(2,2,-1).unit(),this.causticTex=new m.Texture(1024,1024),this.waterShaders=[];for(var T=0;T<2;T++)this.waterShaders[T]=new m.Shader("      uniform sampler2D water;      uniform vec3 poolSizeVertexShader;      varying vec3 position;      void main() {        vec4 info = texture2D(water, gl_Vertex.xy / poolSizeVertexShader.xz + 0.5);        position = gl_Vertex.xzy;        position.y += info.r;        gl_Position = gl_ModelViewProjectionMatrix * vec4(position, 1.0);      }    ",te+'      uniform vec3 eye;      varying vec3 position;      uniform samplerCube sky;      uniform float wr;      uniform bool showProjectionGrid;      uniform bool showAreaConservedGrid;            bool isOnConservedAreaGrid(vec2 pos, float size) {        vec2 gridCoord = pos / size;        return abs(fract(gridCoord.x) - 0.5) < 0.05 || abs(fract(gridCoord.y) - 0.5) < 0.05;      }      vec3 getSurfaceRayColor(vec3 origin, vec3 ray, vec3 waterColor) {        vec3 color;        float q = intersectSphere(origin, ray, sphereCenter, sphereRadius);        if (q < 1.0e6) {          color = getSphereColor(origin + ray * q);        } else if (ray.y < 0.0) {          vec2 t = intersectCube(origin, ray, vec3(-poolSize.x / 2., -poolSize.y, -poolSize.z / 2.), vec3(poolSize.x / 2., poolSize.y, poolSize.z / 2.));          color = getWallColor(origin + ray * t.y);        } else {          vec2 t = intersectCube(origin, ray, vec3(-poolSize.x / 2., -poolSize.y, -poolSize.z / 2.), vec3(poolSize.x / 2., poolSize.y, poolSize.z / 2.));          vec3 hit = origin + ray * t.y;          if (hit.y < 2.0 / 12.0) {            color = getWallColor(hit);          } else {            color = textureCube(sky, ray).rgb;            color += vec3(pow(max(0.0, dot(light, ray)), 5000.0)) * vec3(10.0, 8.0, 6.0);          }        }        if (ray.y < 0.0) {          color *= waterColor;          vec2 position = origin.xz;          vec2 flagCorner = flagCenter - flagSize / 2.;          if (showProjectionGrid && isOnConservedAreaGrid(position, 0.1)) color = vec3(1., 1., 0.); /* Debug conserved area grid */          if (abs(origin.z + poolSize.z / 2. - wr) < .05) color = vec3(1., 1., 0.);           if (areaConservation) {            vec2 coord = origin.xz / poolSize.xz + 0.5;            position = texture2D(areaConservationTexture, coord).xy;            flagCorner = texture2D(areaConservationTexture, flagCorner / poolSize.xz + 0.5).xy;          }          if (showAreaConservedGrid && isOnConservedAreaGrid(position, 0.1)) color = vec3(1., 0., 0.); /* Debug conserved area grid */          float xFlag = position.x - flagCenter.x;          float yFlag = position.y - flagCenter.y;          vec2 posFlag = position - flagCenter;          posFlag = position - flagCorner - flagSize / 2.;/*Fixes the corner of the flag on the XZ plane*/          if (abs(posFlag.x) <= flagSize / 2. && abs(posFlag.y) <= flagSize / 2.) {            vec2 flagCoord = posFlag / flagSize + 0.5;            vec3 flagColor = texture2D(flag, flagCoord).xyz;            flagColor = flagCoord.x <= .33 ? vec3(1., 0., 0.) : flagCoord.x >= .66 ? vec3(0., 0., 1.) : vec3(1., 1., 1.);            color += flagColor;            color /= 2.;          }        }        return color;      }            void main() {        vec2 coord = position.xz / poolSize.xz + 0.5;        vec4 info = texture2D(water, coord);                /* make water look more "peaked" */        /*for (int i = 0; i < 5; i++) {          coord += info.ba * 0.005;          info = texture2D(water, coord);        }*/                vec3 normal = vec3(info.b, sqrt(1.0 - dot(info.ba, info.ba)), info.a);        vec3 incomingRay = normalize(position - eye);                '+(T?"          normal = -normal;          vec3 reflectedRay = reflect(incomingRay, normal);          vec3 refractedRay = refract(incomingRay, normal, IOR_WATER / IOR_AIR);          float fresnel = mix(0.5, 1.0, pow(1.0 - dot(normal, -incomingRay), 3.0));                    vec3 reflectedColor = getSurfaceRayColor(position, reflectedRay, underwaterColor);          vec3 refractedColor = getSurfaceRayColor(position, refractedRay, vec3(1.0)) * vec3(0.8, 1.0, 1.1);                    gl_FragColor = vec4(mix(reflectedColor, refractedColor, (1.0 - fresnel) * length(refractedRay)), 1.0);        ":"          vec3 reflectedRay = reflect(incomingRay, normal);          vec3 refractedRay = refract(incomingRay, normal, IOR_AIR / IOR_WATER);          float fresnel = mix(0.25, 1.0, pow(1.0 - dot(normal, -incomingRay), 3.0));                    vec3 reflectedColor = getSurfaceRayColor(position, reflectedRay, abovewaterColor);          vec3 refractedColor = getSurfaceRayColor(position, refractedRay, abovewaterColor);                    gl_FragColor = vec4(mix(refractedColor, reflectedColor, fresnel), 1.0);        ")+"      }    ");this.sphereMesh=m.Mesh.sphere({detail:10}),this.sphereShader=new m.Shader(te+"    varying vec3 position;    void main() {      position = sphereCenter + gl_Vertex.xyz * sphereRadius;      gl_Position = gl_ModelViewProjectionMatrix * vec4(position, 1.0);    }  ",te+"    varying vec3 position;    void main() {      gl_FragColor = vec4(getSphereColor(position), 1.0);      vec4 info = texture2D(water, position.xz / poolSize.xz + 0.5);      if (position.y < info.r) {        gl_FragColor.rgb *= underwaterColor * 1.2;      }    }  "),this.reset(),this.cubeShader=new m.Shader(te+"    varying vec3 position;    void main() {      position = gl_Vertex.xyz;      position.y = ((1.0 - position.y) * (7.0 / 12.0) - 1.0) * poolSize.y;      gl_Position = gl_ModelViewProjectionMatrix * vec4(position, 1.0);    }  ",te+"    varying vec3 position;    void main() {      gl_FragColor = vec4(getWallColor(position), 1.0);      vec4 info = texture2D(water, position.xz / poolSize.xz + 0.5);      if (position.y < info.r) {        gl_FragColor.rgb *= underwaterColor * 1.2;      }    }  "),this.sphereCenter=new m.Vector,this.sphereRadius=0;var A=!!this.gl.getExtension("OES_standard_derivatives");this.causticsShader=new m.Shader(te+"    varying vec3 oldPos;    varying vec3 newPos;    varying vec3 ray;        /* project the ray onto the plane */    vec3 project(vec3 origin, vec3 ray, vec3 refractedLight) {      vec2 tcube = intersectCube(origin, ray, vec3(-poolSize.x / 2., -poolSize.y, -poolSize.z / 2.), vec3(poolSize.x / 2., poolSize.y, poolSize.z / 2.));      origin += ray * tcube.y;      float tplane = (-origin.y - 1.0) / refractedLight.y;      return origin + refractedLight * tplane;    }        void main() {      vec2 coord = gl_Vertex.xy / poolSize.xz + 0.5;      vec4 info = texture2D(water, coord);      info.ba *= 0.5;      vec3 normal = vec3(info.b, sqrt(1.0 - dot(info.ba, info.ba)), info.a);            /* project the vertices along the refracted vertex ray */      vec3 refractedLight = refract(-light, vec3(0.0, 1.0, 0.0), IOR_AIR / IOR_WATER);      ray = refract(-light, normal, IOR_AIR / IOR_WATER);      oldPos = project(gl_Vertex.xzy, refractedLight, refractedLight);      newPos = project(gl_Vertex.xzy + vec3(0.0, info.r, 0.0), ray, refractedLight);            gl_Position = vec4(0.75 * (newPos.xz + refractedLight.xz / refractedLight.y), 0.0, 1.0);    }  ",(A?`#extension GL_OES_standard_derivatives : enable
`:"")+"    "+te+"    varying vec3 oldPos;    varying vec3 newPos;    varying vec3 ray;        void main() {      "+(A?"        /* if the triangle gets smaller, it gets brighter, and vice versa */        float oldArea = length(dFdx(oldPos)) * length(dFdy(oldPos));        float newArea = length(dFdx(newPos)) * length(dFdy(newPos));        gl_FragColor = vec4(oldArea / newArea * 0.2, 1.0, 0.0, 0.0);      ":"        gl_FragColor = vec4(0.2, 0.2, 0.0, 0.0);      ")+"            vec3 refractedLight = refract(-light, vec3(0.0, 1.0, 0.0), IOR_AIR / IOR_WATER);            /* compute a blob shadow and make sure we only draw a shadow if the player is blocking the light */      vec3 dir = (sphereCenter - newPos) / sphereRadius;      vec3 area = cross(dir, refractedLight);      float shadow = dot(area, area);      float dist = dot(dir, -refractedLight);      shadow = 1.0 + (shadow - 1.0) / (0.05 + dist * 0.025);      shadow = clamp(1.0 / (1.0 + exp(-shadow)), 0.0, 1.0);      shadow = mix(1.0, shadow, clamp(dist * 2.0, 0.0, 1.0));      gl_FragColor.g = shadow;            /* shadow for the rim of the pool */      vec2 t = intersectCube(newPos, -refractedLight, vec3(-poolSize.x / 2., -poolSize.y, -poolSize.z / 2.), vec3(poolSize.x / 2., poolSize.y, poolSize.z / 2.));      gl_FragColor.r *= 1.0 / (1.0 + exp(-200.0 / (1.0 + 10.0 * (t.y - t.x)) * (newPos.y - refractedLight.y * t.y - 2.0 / 12.0)));    }  ")}Z.prototype.reset=function(){this.cubeMesh=m.Mesh.cube({width:this.water.poolSize.x,height:2,depth:this.water.poolSize.z}),this.cubeMesh.triangles.splice(4,2),this.cubeMesh.compile()};Z.prototype.updateCaustics=function(o){};Z.prototype.renderWater=function(o,a){var p=new m.Raytracer;o.textureA.bind(0),this.tileTexture.bind(1),a.bind(2),this.causticTex.bind(3),this.flagTexture.bind(4),o.areaConservationTexture.bind(5),this.gl.enable(this.gl.CULL_FACE);for(var g=0;g<2;g++)this.gl.cullFace(g?this.gl.BACK:this.gl.FRONT),this.waterShaders[g].uniforms({light:this.lightDir,water:0,tiles:1,sky:2,causticTex:3,flag:4,areaConservationTexture:5,areaConservation:o.areaConservationEnabled,flagSize:this.flagSize,flagCenter:[this.flagCenter.x,this.flagCenter.y],poolSize:[o.poolSize.x,o.poolSize.y,o.poolSize.z],poolSizeVertexShader:[o.poolSize.x,o.poolSize.y,o.poolSize.z],eye:p.eye,sphereCenter:this.sphereCenter,sphereRadius:this.sphereRadius,showProjectionGrid:o.showProjectionGrid,showAreaConservedGrid:o.showAreaConservedGrid,wr:o.WR_position}).draw(o.plane);this.gl.disable(this.gl.CULL_FACE)};Z.prototype.renderSpheres=function(o){for(let a of o.spheres)this.renderSphere(o,a)};Z.prototype.renderSphere=function(o,a){o.textureA.bind(0),this.causticTex.bind(1),this.sphereShader.uniforms({light:this.lightDir,water:0,causticTex:1,sphereCenter:[a.center.x,a.center.y,a.center.z],sphereRadius:a.radius,poolSize:[o.poolSize.x,o.poolSize.y,o.poolSize.z]}).draw(a.mesh)};Z.prototype.renderSphereOld=function(o){o.textureA.bind(0),this.causticTex.bind(1),this.sphereShader.uniforms({light:this.lightDir,water:0,causticTex:1,sphereCenter:this.sphereCenter,sphereRadius:this.sphereRadius,poolSize:[o.poolSize.x,o.poolSize.y,o.poolSize.z]}).draw(this.sphereMesh)};Z.prototype.renderCube=function(o){this.gl.enable(this.gl.CULL_FACE),o.textureA.bind(0),this.tileTexture.bind(1),this.causticTex.bind(2),this.cubeShader.uniforms({light:this.lightDir,water:0,tiles:1,causticTex:2,sphereCenter:this.sphereCenter,sphereRadius:this.sphereRadius,poolSize:[o.poolSize.x,o.poolSize.y,o.poolSize.z]}).draw(this.cubeMesh),this.gl.disable(this.gl.CULL_FACE)};function ye(o,a){this.gl=a,this.id=a.createTexture(),a.bindTexture(a.TEXTURE_CUBE_MAP,this.id),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,1),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MAG_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_MIN_FILTER,a.LINEAR),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_S,a.CLAMP_TO_EDGE),a.texParameteri(a.TEXTURE_CUBE_MAP,a.TEXTURE_WRAP_T,a.CLAMP_TO_EDGE),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_X,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,o.xneg),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_X,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,o.xpos),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Y,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,o.yneg),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Y,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,o.ypos),a.texImage2D(a.TEXTURE_CUBE_MAP_NEGATIVE_Z,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,o.zneg),a.texImage2D(a.TEXTURE_CUBE_MAP_POSITIVE_Z,0,a.RGB,a.RGB,a.UNSIGNED_BYTE,o.zpos)}ye.prototype.bind=function(o){this.gl.activeTexture(this.gl.TEXTURE0+(o||0)),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,this.id)};ye.prototype.unbind=function(o){this.gl.activeTexture(this.gl.TEXTURE0+(o||0)),this.gl.bindTexture(this.gl.TEXTURE_CUBE_MAP,null)};class Ce{constructor(a){if(this.gl=a,this.copyVideo=!1,this.show=!1,this.deltaTime=0,a===null){alert("Unable to initialize WebGL. Your browser or machine may not support it.");return}a.clearColor(0,0,0,1),a.clear(a.COLOR_BUFFER_BIT),this.shader=new m.Shader(`
    varying highp vec2 vTextureCoord;

    void main(void) {
        gl_Position = vec4(gl_Vertex.xz, 0., 1.);
        vTextureCoord = gl_TexCoord.st;
    }
`,`
    varying highp vec2 vTextureCoord;

    uniform sampler2D uSampler;

    void main(void) {
        highp vec4 texelColor = texture2D(uSampler, vTextureCoord);
        gl_FragColor = vec4(texelColor.rgb, 0.5);
        // gl_FragColor = vec4(1, 0, 0, 1);
    }
`),this.mesh=m.Mesh.plane({width:2,height:2,coords:!0,normals:!0}),this.mesh.transform(m.Matrix.rotate(90,1,0,0)),this.mesh.transform(m.Matrix.translate(0,.1,0)),this.programInfo=null,this.texture=this.initTexture(),this.video=this.setupVideo(),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!0),this.then=0}render(a){this.show&&(a*=.001,console.log("rendering : "+this.copyVideo),this.deltaTime=a-this.then,this.then=a,this.copyVideo&&this.updateTexture(),(!this.mesh.vertexBuffers||!this.mesh.vertexBuffers.vertex)&&this.mesh.compile(),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.shader.uniforms({uSampler:0}).draw(this.mesh),this.gl.disable(this.gl.BLEND))}initShaderProgram(a,p){const g=this.loadShader(this.gl.VERTEX_SHADER,a),T=this.loadShader(this.gl.FRAGMENT_SHADER,p),A=this.gl.createProgram();return this.gl.attachShader(A,g),this.gl.attachShader(A,T),this.gl.linkProgram(A),this.gl.getProgramParameter(A,this.gl.LINK_STATUS)?A:(alert(`Unable to initialize the shader program: ${this.gl.getProgramInfoLog(A)}`),null)}loadShader(a,p){const g=this.gl.createShader(a);return this.gl.shaderSource(g,p),this.gl.compileShader(g),this.gl.getShaderParameter(g,this.gl.COMPILE_STATUS)?g:(alert(`An error occurred compiling the shaders: ${this.gl.getShaderInfoLog(g)}`),this.gl.deleteShader(g),null)}initTexture(){const a=this.gl.createTexture();this.gl.bindTexture(this.gl.TEXTURE_2D,a);const p=0,g=this.gl.RGBA,T=1,A=1,M=0,D=this.gl.RGBA,Q=this.gl.UNSIGNED_BYTE,K=new Uint8Array([0,0,255,255]);return this.gl.texImage2D(this.gl.TEXTURE_2D,p,g,T,A,M,D,Q,K),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),a}updateTexture(){const p=this.gl.RGBA,g=this.gl.RGBA,T=this.gl.UNSIGNED_BYTE;this.gl.bindTexture(this.gl.TEXTURE_2D,this.texture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,p,g,T,this.video)}setupVideo(){const a=document.createElement("video");let p=!1,g=!1;a.playsInline=!0,a.muted=!0,a.loop=!0,a.addEventListener("playing",()=>{p=!0,A()},!0),a.addEventListener("timeupdate",()=>{g=!0,A()},!0),a.play();const T=this,A=()=>{p&&g&&(T.copyVideo=!0)};return a}}function Fe(o){return o.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\n/g,"<br>")}function Pe(o){var a=Fe(o);a=="WebGL not supported"&&(a='Your browser does not support WebGL.<br>Please see    <a href="http://www.khronos.org/webgl/wiki/Getting_a_WebGL_Implementation">    Getting a WebGL Implementation</a>.');var p=document.getElementById("loading");p.innerHTML=a,p.style.zIndex=1}window.onerror=Pe;var _=m.create(),R,Te,U;const V=[],ve=8;var ae=-25,ue=-200.5;let ge=0,pe=0;var se=4,Y=!1,fe,xe,S=new m.Vector(2,1,2);let F=new m.Vector(256,256),Ie={numSteps:2};const De=new ze;function _e(){document.getElementById("warning").hidden=!(F.x*F.y>3e5&&R&&R.areaConservationEnabled)}function j(){console.log("reset"),document.getElementById("resolution").innerText=`Resolution: ${F.x} x ${F.y}`,_e(),fe=new m.Vector(0,-S.z/2+1),R.reset(S,F),U.flagCenter=fe,U.flagSize=xe,U.reset();const o=S.x/ve;let a=-S.x/2+o/2;for(let p of V)p.body.center.x=a,p.startingPoint.x=a,a+=o}window.onload=function(){var o=window.devicePixelRatio||1,a=document.getElementById("help");function p(){var r=innerWidth,n=innerHeight;_.canvas.width=r*o,_.canvas.height=n*o,_.canvas.style.width=r+"px",_.canvas.style.height=n+"px",_.viewport(0,0,_.canvas.width,_.canvas.height),_.matrixMode(_.PROJECTION),_.loadIdentity(),_.perspective(45,_.canvas.width/_.canvas.height,.01,100),_.matrixMode(_.MODELVIEW),e()}document.body.appendChild(_.canvas),_.canvas.oncontextmenu=function(r){r.preventDefault()},_.clearColor(0,0,0,1),fe=new m.Vector(0,-S.z/2+1),xe=.7,R=new H(_,S);const g=new Ce(_),T=document.getElementById("drop-zone");let A=0;document.addEventListener("dragenter",r=>{A++,T.style.display="flex"}),document.addEventListener("dragover",r=>{r.preventDefault(),r.dataTransfer.dropEffect="copy"}),document.addEventListener("dragleave",r=>{A--,A===0&&(T.style.display="none")}),document.addEventListener("drop",r=>{r.preventDefault(),A=0,T.style.display="none";const n=r.dataTransfer.files;if(n.length>0&&(n[0].type.startsWith("video/")||n[0].name.endsWith(".mp4"))){const s=URL.createObjectURL(n[0]);g.video.src=s,g.video.play(),console.log("Loaded:",n[0].name)}});const M=De.addFolder("variables");if(M.add(S,"x",1,25).name("pool width").onChange(function(r){j()}).listen(),M.add(S,"z",1,50).name("pool height").onChange(function(r){j()}).listen(),M.add(S,"y",1,3).name("pool depth").onChange(function(r){j()}).listen(),M.add(R,"areaConservationEnabled","areaConservationEnabled").name("area conservation").listen(),U=new Z(_,R,fe,xe),Te=new ye({xneg:document.getElementById("xneg"),xpos:document.getElementById("xpos"),yneg:document.getElementById("ypos"),ypos:document.getElementById("ypos"),zneg:document.getElementById("zneg"),zpos:document.getElementById("zpos")},_),!R.textureA.canDrawTo()||!R.textureB.canDrawTo())throw new Error("Rendering to floating-point textures is required but not supported");const D=new m.Vector(-.4,-.75,.2),Q=new m.Vector(.4,-.75,.2),K=new L(D);new L(Q);for(let r=0;r<1;r++)V.push(new L(D));const B=K.body.radius;for(let r of V)R.addSwimmer(r);j();for(var y=0;y<20;y++)R.addDrop(Math.random()*2-1,Math.random()*2-1,.06,y&1?.01:-.01);document.getElementById("loading").innerHTML="",p();var N=window.requestAnimationFrame||window.webkitRequestAnimationFrame||function(r){setTimeout(r,0)},G=new Date().getTime();function P(){var r=new Date().getTime();Y||(i((r-G)/1e3,r/1e3),e(r)),G=r,N(P)}N(P),window.onresize=p;var k,W,I,O=-1,re=0,$=1,ie=2;const de=3;var oe,C;function q(r,n,s){if(oe=r,C=n,!s||s.button===0){var l=new m.Raytracer,h=l.getRayForPixel(r*o,n*o),f=l.eye.add(h.multiply(-l.eye.y/h.y));for(let c of V){var d=m.Raytracer.hitTestSphere(l.eye,h,c.body.center,c.body.radius);if(d){O=$,I=c,c.body.cinematic=!0,k=d.hit,W=l.getRayForPixel(_.canvas.width/2,_.canvas.height/2).negative();return}}Math.abs(f.x)<S.x/2&&Math.abs(f.z)<S.z/2&&(O=re,X(r,n))}else s.button===2?O=ie:s.button===1&&(O=de)}function X(r,n){switch(O){case re:{var s=new m.Raytracer,l=s.getRayForPixel(r*o,n*o),h=s.eye.add(l.multiply(-s.eye.y/l.y));R.addDrop(h.x/S.x*2,h.z/S.z*2,.06,.03),Y&&(R.updateNormals(),U.updateCaustics(R));break}case $:{var s=new m.Raytracer,l=s.getRayForPixel(r*o,n*o),f=-W.dot(s.eye.subtract(k))/W.dot(l),d=s.eye.add(l.multiply(f));const w=I.body.center.add(d.subtract(k)),x=I.body.radius,E=Math.max(x-S.x/2,Math.min(S.x/2-x,w.x)),b=Math.max(x-S.y,Math.min(10,w.y)),z=Math.max(x-S.z/2,Math.min(S.z/2-x,w.z));I.body.move(new m.Vector(E,b,z)),k=d,Y&&U.updateCaustics(R);break}case ie:{ue-=r-oe,ae-=n-C,ae=Math.max(-89.999,Math.min(89.999,ae));break}case de:{const c=.001*se;ge+=c*(r-oe),pe-=c*(n-C)}}oe=r,C=n,Y&&e()}function ne(){O=-1,I&&(I.body.cinematic=!L.useGravity)}function u(r){return r===a||r.parentNode&&u(r.parentNode)}function t(r){se*=1-r*.001,se=Math.max(2,Math.min(50,se)),Y&&e()}addEventListener("wheel",function(r){var n=r.deltaY;t(-n)}),document.onmousedown=function(r){u(r.target)||(r.preventDefault(),q(r.pageX,r.pageY,r))},document.onmousemove=function(r){X(r.pageX,r.pageY)},document.onmouseup=function(){ne()},document.ontouchstart=function(r){r.touches.length===1&&!u(r.target)&&(r.preventDefault(),q(r.touches[0].pageX,r.touches[0].pageY,!1))},document.ontouchmove=function(r){r.touches.length===1&&X(r.touches[0].pageX,r.touches[0].pageY)},document.ontouchend=function(r){r.touches.length==0&&ne()},document.onkeydown=function(r){if(r.which==32)Y=!Y;else if(r.which==71){for(let n of V)n.body.cinematic=!n.body.cinematic;L.useGravity=!L.useGravity}else if(r.which==76&&Y)e();else if(r.which==74){L.useGravity=!0;for(let n of V)n.body.cinematic=!1,n.body.velocity=new m.Vector(0,0,1.5),n.body.center=new m.Vector(n.startingPoint.x,1,-S.z/2)}else if(r.which==67)R.setAreaConservation(!R.areaConservationEnabled),_e(),console.log("Area conservation "+(R.areaConservationEnabled?"enabled.":"disabled."));else if(r.which==80)R.showProjectionGrid=!R.showProjectionGrid,console.log("Projection grid "+(R.showProjectionGrid?"enabled.":"disabled."));else if(r.which==65)R.showAreaConservedGrid=!R.showAreaConservedGrid,console.log("Area conserved grid "+(R.showAreaConservedGrid?"enabled.":"disabled."));else if(r.which==83){L.swimming=!L.swimming;for(let n of V)L.swimming?(n.body.cinematic=!1,L.useGravity=!0,n.body.center=new m.Vector(n.startingPoint.x,0,-S.z/2)):(n.body.velocity=new m.Vector(0,0,0),n.body.center=new m.Vector(n.startingPoint.x,0,0));console.log("Swimming "+(L.swimming?"enabled.":"disabled."))}else if(r.which==86)g.show=!g.show;else if(r.which==79){if(S.x=25,S.y=2,S.z=50,F.x=1024,F.y=2048,R.setAreaConservation(!1),R.waveVelocity=2.5,V.length!=ve)for(let n=V.length;n<ve;n++){const s=new L(D);V.push(s),R.addSwimmer(s)}j(),ge=-17.005,pe=-.79,se=29.91,ae=-18,ue=-269.5,console.log("Olympic mode enabled.")}else r.which==87?R.WR_position=0:r.which==72?(document.getElementById("commands").hidden=!document.getElementById("commands").hidden,document.getElementById("h").hidden=!document.getElementById("h").hidden):r.which==40?(F.x>129&&(F.x=Math.round(F.x/2)),j(),console.log("decreasing x resolution")):r.which==38?(F.x<16384&&(F.x=Math.round(F.x*2)),j(),console.log("increasing x resolution")):r.which==37?(F.y>129&&(F.y=Math.round(F.y/2)),j(),console.log("decreasing y resolution")):r.which==39&&(F.y<16384&&(F.y=Math.round(F.y*2)),j(),console.log("increasing y resolution"))};function i(r,n){if(!(r>1)){if(O==$)for(let s of V)s.body.velocity=new m.Vector(0,0,0);for(let s of V)s.update(r,n,S);R.updateSpheres(r);for(let s=0;s<Ie.numSteps;s++)R.stepSimulation();R.updateNormals(),U.updateCaustics(R)}}function e(r){m.keys.L&&(U.lightDir=m.Vector.fromAngles((90-ue)*Math.PI/180,-ae*Math.PI/180),Y&&U.updateCaustics(R)),_.clear(_.COLOR_BUFFER_BIT|_.DEPTH_BUFFER_BIT),_.loadIdentity(),_.translate(ge,pe,-se),_.rotate(-ae,1,0,0),_.rotate(-ue,0,1,0),_.translate(0,.5,0),_.enable(_.DEPTH_TEST),U.sphereCenter=V[0].body.center,U.sphereRadius=B,U.renderCube(R),U.renderWater(R,Te),U.renderSpheres(R),g.render(r),_.disable(_.DEPTH_TEST)}};
//# sourceMappingURL=swimming-CR1oJIlp.js.map
