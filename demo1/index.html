<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>three_vite</title>
  <link rel="icon" href="favicon.png">
  <link rel="stylesheet" href="./main.css">
</head>

<body>
  <div id="container"></div>

  <script type="x-shader/x-vertex" id="vertexShader">


    uniform vec2[20] k_array;
    uniform float[20] omega_array;
    uniform float amplitude_factor;
    uniform float amplitude;

    uniform float t;

    int order = 20;

    varying vec3 vWorldPosition;
    varying vec3 fragNormal;
    varying vec3 fragPos;

    float waveFunction(vec3 pos, float t) {
      float y = 0.0;
      for (int i = 0; i < order; i++) {
        float s = sin(dot(k_array[i], pos.xz) + omega_array[i] * t) * amplitude * pow(amplitude_factor, float(i));
        y += exp(s - 1.0);
      }
      return y;
    }

    vec3 getNormal(vec3 pos, float t) {
      float dx = 0.0;
      float dz = 0.0;
      for (int i = 0; i < order; i++) {
        float s = sin(dot(k_array[i], pos.xz) + omega_array[i] * t) * amplitude * pow(amplitude_factor, float(i));
        float dx_sin = k_array[i].x * cos(dot(k_array[i], pos.xz) + omega_array[i] * t) * amplitude * pow(amplitude_factor, float(i));
        float dz_sin = k_array[i].y * cos(dot(k_array[i], pos.xz) + omega_array[i] * t) * amplitude * pow(amplitude_factor, float(i));
        float e = exp(s - 1.0);
        dx += dx_sin * e;
        dz += dz_sin * e;
      }
      vec3 tangent = vec3(1.0, dx, 0.0);
      vec3 binormal = vec3(0.0, dz, 1.0);
      vec3 normal = -normalize(cross(tangent, binormal));
      return normal;
    }

    void main() {
      vec3 newPos = vec3(position.x, waveFunction(position, t), position.z );
      fragPos = vec3(modelViewMatrix * vec4(newPos, 1.0));
      fragPos = newPos;
      fragNormal = getNormal(position, t);
      gl_Position = projectionMatrix * modelViewMatrix * vec4( newPos, 1.0 );
    }

  </script>

  <script type="x-shader/x-fragment" id="fragmentShader">

    uniform vec3 deepColor;
    uniform vec3 shallowColor;
    uniform vec3 lightColor;
    uniform vec3 lightDirection;
    uniform vec3 viewPos;
    uniform float shininess;

    varying vec3 vWorldPosition;
    varying vec3 fragPos;
    varying vec3 fragNormal;

    vec3 getAmbient() {
      float ambientStrength = 0.2;
      vec3 ambient = ambientStrength * deepColor;
      return ambient;
    }

    vec3 getDiffuse(vec3 normal) {
      float diffuseIntensity = max(-dot(lightDirection, normal), 0.0);
      vec3 diffuse = diffuseIntensity * deepColor;
      return diffuse;
    }

    vec3 getSpecular(vec3 normal) {
      vec3 viewDir = normalize(viewPos - fragPos);
      vec3 h = normalize(-lightDirection + viewDir);
      float specularStrength = pow(max(dot(h, normal), 0.0), shininess);
      vec3 specular = specularStrength * lightColor;
      return specular;
    }


    void main() {
      


      vec3 normal = normalize(fragNormal);

      float h = (fragPos.y + 1.0) / 2.0;
      float s = h*h;
      vec3 color = s * shallowColor + (1.0-s) * deepColor;
      


      //vec3 ey = vec3(0.0, 1.0, 0.0);
      //float deepness = abs(dot(ey, normal));
      //vec3 color = deepness * deepColor + (1.0 - deepness) * shallowColor;

      
      //float h = normalize( vWorldPosition + offset ).y;

      //gl_FragColor = vec4((getAmbient() + getDiffuse(normal)) * deepColor, 1.0);
      gl_FragColor = vec4((getAmbient() + getDiffuse(normal)) + getSpecular(normal), 1.0);
      //gl_FragColor = vec4(0.0, 0.0, 1.0, 1.0);

    }

  </script>

  <!--
  <script src="./jsm/libs/ammo.wasm.js"></script>
  -->
  <script type="module" src="./main.js"></script>
</body>

</html>